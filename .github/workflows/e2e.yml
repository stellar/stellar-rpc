name: Soroban Tools e2e

on:
  push:
    branches: [ main, release/** ]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_protected == 'true' && github.sha || github.ref }}
  cancel-in-progress: true

jobs:
  build-quickstart:
    uses: stellar/quickstart/.github/workflows/build.yml@main
    with:
      images: |
        [
          {
            "tag": "rpc-custom",
            "config": {
              "protocol_version_default": 23
            },
            "deps": [
              { "name": "xdr", "repo": "stellar/rs-stellar-xdr", "ref": "v23.0.0" },
              { "name": "core", "repo": "stellar/stellar-core", "ref": "v23.0.1", "options": { "configure_flags": "--disable-tests" } },
              { "name": "rpc", "repo": "stellar/stellar-rpc", "ref": "${{ github.ref }}" },
              { "name": "horizon", "repo": "stellar/go", "ref": "horizon-v23.0.0" },
              { "name": "friendbot", "repo": "stellar/go", "ref": "horizon-v23.0.0" },
              { "name": "lab", "repo": "stellar/laboratory", "ref": "main" }
            ],
            "additional-tests": []
          }
        ]
      archs: '["amd64"]'
  run-quickstart:
    # this will host rpc at http://localhost:8000/rpc
    needs: build-quickstart
    runs-on: ubuntu-latest
    steps:
    - uses: stellar/quickstart@main
      with:
        artifact: image-quickstart-rpc-custom-amd64.tar
        tag: rpc-custom-amd64
        enable: core,rpc

  build-system-test:
    runs-on: ubuntu-latest-4-cores
    env: 
      # the gh tag of system-test repo version to run
      SYSTEM_TEST_GIT_REF: refs/pull/146/head

      # the soroban CLI source code to compile and run from system test
      SYSTEM_TEST_STELLAR_CLI_REF: https://github.com/stellar/stellar-cli.git\#main

      # sets the version of rust toolchain that will be pre-installed in the
      # test runtime environment, tests invoke rustc/cargo
      SYSTEM_TEST_RUST_TOOLCHAIN_VERSION: stable

      # set the version of js-stellar-sdk to use, need to choose one of either
      # resolution options, using npm release or a gh ref:
      #
      # option #1, set the version of stellar-sdk based on a npm release version
      SYSTEM_TEST_JS_STELLAR_SDK_NPM_VERSION: 14.0.0
      # option #2, set the version of stellar-sdk used as a ref to a gh repo if
      # a value is set on SYSTEM_TEST_JS_STELLAR_SDK_GH_REPO, it takes
      # precedence over any SYSTEM_TEST_JS_STELLAR_SDK_NPM_VERSION
      SYSTEM_TEST_JS_STELLAR_SDK_GH_REPO:
      SYSTEM_TEST_JS_STELLAR_SDK_GH_REF:
    steps:
    - uses: actions/checkout@v4
      name: checkout system-test
      with:
        repository: stellar/system-test
        ref: ${{ env.SYSTEM_TEST_GIT_REF }}
        path: system-test
    - if: ${{ env.SYSTEM_TEST_JS_STELLAR_SDK_GH_REPO != ''}}
      name: prepare local js-stellar-sdk
      run: |
        rm -rf $GITHUB_WORKSPACE/system-test/js-stellar-sdk;
    - if: ${{ env.SYSTEM_TEST_JS_STELLAR_SDK_GH_REPO != ''}}
      uses: actions/checkout@v4
      with:
        repository: ${{ env.SYSTEM_TEST_JS_STELLAR_SDK_GH_REPO }}
        ref: ${{ env.SYSTEM_TEST_JS_STELLAR_SDK_GH_REF }}
        path: system-test/js-stellar-sdk
    - uses: stellar/actions/rust-cache@main
    - name: Build system test with component versions
      run: |
        cd $GITHUB_WORKSPACE/system-test
        if [ -z "$SYSTEM_TEST_JS_STELLAR_SDK_GH_REPO" ]; then \
          JS_STELLAR_SDK_REF="$SYSTEM_TEST_JS_STELLAR_SDK_NPM_VERSION"; \
        else \
          JS_STELLAR_SDK_REF="file:/home/tester/js-stellar-sdk"; \
        fi
        make \
          STELLAR_CLI_GIT_REF=$SYSTEM_TEST_STELLAR_CLI_REF \
          RUST_TOOLCHAIN_VERSION=$SYSTEM_TEST_RUST_TOOLCHAIN_VERSION \
          JS_STELLAR_SDK_NPM_VERSION=$JS_STELLAR_SDK_REF \
          build 

  integration:
    name: System tests
    needs: [build-system-test,run-quickstart]
    strategy:
      matrix:
        scenario-filter: [ "^TestDappDevelop$/^.*$" ]
    runs-on: ubuntu-latest
    env:
      SYSTEM_TEST_VERBOSE_OUTPUT: "true"

      # the soroban test cases will compile various contracts from the examples repo
      SYSTEM_TEST_SOROBAN_EXAMPLES_GIT_HASH: "v22.0.1"
      SYSTEM_TEST_SOROBAN_EXAMPLES_GIT_REPO: "https://github.com/stellar/soroban-examples.git"
    steps:
      - name: Run system test scenarios
        run: |
          docker run \
          --rm -t --name e2e_test stellar/system-test:dev \
          --VerboseOutput $SYSTEM_TEST_VERBOSE_OUTPUT  \
          --TargetNetworkRPCURL http://host.docker.internal:8000/rpc \
          --TestFilter "${{ matrix.scenario-filter }}" \
          --SorobanExamplesGitHash $SYSTEM_TEST_SOROBAN_EXAMPLES_GIT_HASH \
          --SorobanExamplesRepoURL $SYSTEM_TEST_SOROBAN_EXAMPLES_GIT_REPO
